version: "3.9"

services:
  redis:
    restart: unless-stopped
    image: redis
    ports:
      - "6379:6379"

  scrape-service:
    build:
      context: .
    command:
      - /bin/bash
      - -c
      - |
        python /service/scrape_requests/serve.py --max_workers 25
        # python /service/scrape_requests/serve.py --max_workers 25 --secure
        # python -c "while True: pass"
    # ports:
    #   - "50051:50051"
    expose:
      - 50051
    secrets:
      - nginx.cert
      - nginx.key
    # depends_on:
    #   - nginx-reverseproxy
    networks:
      - microservices
    volumes:
      - ./youtube_recommender/config/postgres.cfg:/usr/local/lib/python3.9/site-packages/youtube_recommender/config/postgres.cfg

  nginx-reverseproxy:
    image: nginx:1.13.11
    ports:
      - 127.0.0.1:1443:1443
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    secrets:
      - nginx.cert
      - nginx.key
    depends_on:
      - scrape-service
    networks:
      - microservices

networks:
  microservices:
    external: true

secrets:
  nginx.cert:
    file: ./cert/nginx.cert
  nginx.key:
    file: ./cert/nginx.key
